<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title for WebPage</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/data_entry.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/league.css') }}">
    <script src="{{ url_for('static', filename='js/data_entry.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/league.js') }}" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>


    <style>
        /* body {
          font-family: Arial, sans-serif;
          background-color: #f4f4f4;
          color: #333;
        } */
    
        .chart-container {
          margin: 40px;
        }
        
    
        .bar {
          transition: all 0.3s ease-in-out;
        }
    
        .tooltip {
          position: absolute;
          background-color: rgba(0, 0, 0, 0.7);
          color: white;
          padding: 5px;
          border-radius: 3px;
          pointer-events: none;
          font-size: 12px;
        }
    
        .axis text {
          font-size: 14px;
        }
    
        .axis path, .axis line {
          fill: none;
          shape-rendering: crispEdges;
        }
      </style>
</head>

<body>

    <!-- Sidenav -->
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="/data_entry">Data Entry</a>
        <a href="/Home">Home</a>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <!-- From Uiverse.io by Cevorob -->
        <div class="slide">
            <label class="burger" onclick="openNav()" for="burger">
                <input type="checkbox" id="burger">
                <span></span>
                <span></span>
                <span></span>
            </label>
        </div>
        <div class="logo">
            <img src="/static/logo.png" alt="Profile">
        </div>
        <div class="navbar-title">{{nav_name}}</div>
    </nav>
    </pre>


    <section class="scrollable">
            <!-- Chart Container for Preferred Foot by Position -->
            <div class="chart-container" id="preferred-foot-chart">
                <!-- Filter for Position -->
                <div class="position-filter">
                    <label for="positionSelect-foot">Filter by Position:</label>
                    <select id="positionSelect-foot">
                        <option value="all">All Positions</option>
                        {% for data in pos_attribute_data %}
                            <option value="{{ data.position }}">{{ data.position }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Preferred Foot Chart Section -->
                
                <div id="preferred-foot-chart-container">
                    <h2 class="chart-title">Preferred Foot</h2>
                    <div id="preferred-foot-chart"></div>
                </div>
            </div>
    </section>


    <section class="scrollable">

   





    <div class="age-stats-container">
        

        <div class="position-filter">
            <label for="position-select-age-card">Select Position:</label>
            <select id="position-select-age-card">
                <option value="">All Positions</option>
                {% for stat in position_stats %}
                    <option value="{{ stat.position }}">{{ stat.position }}</option>
                {% endfor %}
            </select>
        </div>

            <div class="age-label">Average Player Age (<span id="position-name"></span>)</div>
            <div class="age-value" id="avg-age"></div>
            <div class="age-label">years</div>
    
            <div class="age-stats-row">
                <div class="age-stat-box">
                    <div class="age-label">Youngest</div>
                    <div class="age-stat-value" id="min-age"></div>
                </div>
                <div class="age-stat-box">
                    <div class="age-label">Oldest</div>
                    <div class="age-stat-value" id="max-age"></div>
                </div>
            </div>
    
            <div class="age-stats-row">
                <div class="age-stat-box career-stat">
                    <div class="age-label">Avg Career Length</div>
                    <div class="age-stat-value" id="avg-career">--</div>
                    <div class="age-label">years</div>
                </div>
            </div>
    
            <div class="age-stats-row">
                <div class="age-stat-box player-count-stat">
                    <div class="age-label">Total Players</div>
                    <div class="age-stat-value" id="position-label">--</div>
                </div>
            </div>
        
    </div>



        
        <!-- <div class="age-stats-container">
            <div class="age-label">Average Player Age</div>
            <div id="average-age" class="age-value">{{avg_age | round(2)}}</div>
            <div class="age-label">years</div>
            
            <div class="age-stats-row">
                <div class="age-stat-box">
                    <div class="age-label">Youngest</div>
                    <div class="age-stat-value">{{min_age}}</div>
                </div>
                <div class="age-stat-box">
                    <div class="age-label">Oldest</div>
                    <div class="age-stat-value">{{max_age}}</div>
                </div>
            </div>
            
            <div class="age-stats-row">
                <div class="age-stat-box career-stat">
                    <div class="age-label">Avg Career Length</div>
                    <div class="age-stat-value">{{avg_career | round(2)}}</div>
                    <div class="age-label">years</div>
                </div>
            </div>
            
            <div class="age-stats-row">
                <div class="age-stat-box player-count-stat">
                    <div class="age-label">Total Players</div>
                    <div class="age-stat-value">{{ nation_results.total_players }}</div>
                </div>
            </div>
        </div> -->

        

        <div class="heatmap-container">
            <div id="position-age-heatmap"></div>
        </div>

        <table id="data-table" style="display: none;">
            <thead>
                <tr>
                    <th>Index</th>
                    <th>Full Name</th>
                    <th>Name</th>
                    <th>Nation</th>
                    <th>League</th>
                    <th>Club</th>
                </tr>
            </thead>
            <tbody>
                {%for data in league_info%}
                    <tr>
                        <td>{{ loop.index }}</td>  
                        <td>{{data.full_name}}</td> 
                        <td>{{data.name}}</td> 
                        <td>{{data.nation_Nation}}</td>
                        <td>{{ data.league_name }}</td> 
                        <td>{{data.club_name}}</td>
                    </tr>
                {%endfor%}
            </tbody>
        </table>
    </section>
    <br>
    <section class="scrollable">
    <div class="bar-chart-container">
        <h2 class="chart-title">Top 5 Player Nationalities</h2>
        <div id="nationality-chart"></div>
    </div>

    <div class="chart-container" id="player-position-chart">
        <h2 class="chart-title">Position Distibution by Nation</h2>
        <div class="position-filter">
            <label for="nationSelect">Filter by Nation:</label>
            <select id="nationSelect">
            <option value="all">All Nations</option>
            <option value="top_by_position">Top Nation per Position</option>
            {% for nation in nation_results.distribution %}
                <option value="{{ nation.nation }}">{{ nation.nation }}</option>
            {% endfor %}
            </select>
        </div>
    </div>

    

    
    </section>


    <section class="scrollable">
        <div class="pyramid-chart-container">
            <h2 class="chart-title">Age Distribution by Position</h2>
            <div class="position-filter">
                <label for="position-select">Select Position:</label>
                <select id="position-select">
                    <option value="all">All Positions</option>
                    {% for stat in position_stats %}
                    <option value="{{ stat.position }}">{{ stat.position }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="age-pyramid-chart"></div>
        </div>
    </div>
    </section>
    <div id="heatmap-data" style="display: none;">
        {% for stat in position_stats %}
            <div class="position-data" 
                 data-position="{{ stat.position }}">
                {% for group, percent in stat.pos_age_groups.items() %}
                    <span class="age-group-data" 
                          data-group="{{ group }}" 
                          data-percent="{{ percent }}"></span>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

    <h1>NEW ADDITION!!! --ADDED THE NALYSIS FOR NATIONS</h1>

    <section>
        <p>The total number of left footed players: {{left_footed_players}}</p>
        <p>The total number of right footed players: {{right_footed_players}}</p>

        <h2>Overall attribute data:</h2>
        <ul>
        {%for data in attribute_data%}
        
            <li>{{data.attribute}} max: {{data.max_score}} min: {{data.min_score}} avg: {{data.avg_score}}  </li>
        {%endfor%}
        </ul>
    </section>

    <section>


        <h3>Position attribute data</h3>
        <ul>
            {%for data in pos_attribute_data%}
            
                <li>Posistion name: {{data.position}} Left footed players: {{data.count_left}} Right footed players: {{data.count_right}} 
                    position total: {{data.pos_total}}  </li>

                    <h3>Pos Scores</h3>
                    <ul>
                        {% for attr, score in data.attributes.items()%}
                            <li> {{attr}}: maximum: {{ score.pos_attr_max }} minimum: {{ score.pos_attr_min }} average: {{ score.pos_attr_avg }}</li>
                        {% endfor %}
                        </ul>
            {%endfor%}
        </ul>
    </section>

    <section>
        <!-- <p>Total Number of players in the league: {{ nation_results.total_players }}</p>
        <p>Country with the most players: {{ nation_results.most_common_nation }} ({{ nation_results.most_common_nation_count }})</p> -->

        <h3>Nation Distribution</h3>
        <ul>
        {% for nation in nation_results.distribution %}
            <li>
            <strong>{{ nation.nation }}</strong>: {{ nation.percentage }}% ({{ nation.count }} players)
            </li>
<!-- 
            <h3>Nation Count</h3>
            <ul>
                {% for pos, data in nation.positions.items()%}
                    <li> {{pos}}: {{ data }}</li>
                {% endfor %}
                </ul> -->

        {% endfor %}
        </ul>


    </section>


    <script>
        const positionStats = {
            {% for stat in position_stats %}
            "{{ stat.position }}": {
                avg_age: {{ stat.avg_age | round(2) }},
                min_age: {{ stat.min_age }},
                max_age: {{ stat.max_age }},
                avg_career: {{ stat.avg_career | round(2) }},
                age_total_count: {{ stat.age_total_count }},
                position: "{{ stat.position }}"
            },
            {% endfor %}
        };
    
        const overallStats = {
            avg_age: {{ avg_age | round(2) }},
            min_age: {{ min_age }},
            max_age: {{ max_age }},
            avg_career: {{ avg_career | round(2) }},
            age_total_count: {{ nation_results.total_players }},
        };
    
        function animateValue(element, start, end, duration = 500) {
            if (start === end) {
                element.textContent = end.toFixed(2);
                return;
            }
            let startTime = null;
            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                const value = start + (end - start) * (progress / duration);
                element.textContent = value.toFixed(2);
                if (progress < duration) {
                    requestAnimationFrame(step);
                } else {
                    element.textContent = end.toFixed(2);
                }
            }
            requestAnimationFrame(step);
        }
    
        document.addEventListener("DOMContentLoaded", function () {
            const select = document.getElementById("position-select-age-card");
    
            const avgAge = document.getElementById("avg-age");
            const minAge = document.getElementById("min-age");
            const maxAge = document.getElementById("max-age");
            const avgCareer = document.getElementById("avg-career");
            const positionLabel = document.getElementById("position-label");
            const positionName = document.getElementById("position-name");
    
            let currentValues = {
                avg_age: 0,
                min_age: 0,
                max_age: 0,
                avg_career: 0,
                age_total_count: 0
            };
    
            function updateCard(position) {
                let data;
                if (position === "overall" || position === "") {
                    data = overallStats;
                    positionLabel.textContent = data.age_total_count;
                    positionName.textContent = "Overall";
                } else {
                    data = positionStats[position];
                    positionLabel.textContent = data.age_total_count;
                    positionName.textContent = data.position;
                }
    
                if (data) {
                    animateValue(avgAge, currentValues.avg_age, data.avg_age);
                    animateValue(minAge, currentValues.min_age, data.min_age);
                    animateValue(maxAge, currentValues.max_age, data.max_age);
                    animateValue(avgCareer, currentValues.avg_career, data.avg_career);
    
                    currentValues = {
                        avg_age: data.avg_age,
                        min_age: data.min_age,
                        max_age: data.max_age,
                        avg_career: data.avg_career,
                        age_total_count: data.age_total_count
                    };
                }
            }
    
            updateCard(select.value);
    
            select.addEventListener("change", function () {
                updateCard(this.value);
            });
        });
    </script>


<script>

    const fullData = {
      {% for nation in nation_results.distribution %}
        "{{ nation.nation }}": {
          {% for pos, count in nation.positions.items() %}
            "{{ pos }}": {{ count }},
          {% endfor %}
        },
      {% endfor %}
    };

    const maxByPositionData = {
        {% for pos, data in nation_results.max_by_position.items() %}
        "{{ pos }}": { nation: "{{ data.nation }}", count: {{ data.count }} },
        {% endfor %}
    };
    

    function getNationData(nation) {
        if (nation === 'top_by_position') {
        return Object.entries(maxByPositionData).map(([position, data]) => ({
            position,
            count: +data.count,
            nation: data.nation
        }));
        }

        const entries = nation === 'all'
        ? aggregateAllNations(fullData)
        : Object.entries(fullData[nation] || {});

        return entries.map(([position, count]) => ({
        position,
        count: +count,
        nation
        }));
    }
  

    function aggregateAllNations(data) {
      const result = {};
      for (const nation of Object.keys(data)) {
        for (const [pos, count] of Object.entries(data[nation])) {
          result[pos] = (result[pos] || 0) + count;
        }
      }
      return Object.entries(result);
    }
  

    const margin = { top: 30, right: 30, bottom: 70, left: 120 };
    const width = 800;
    const height = 400;
  
    const svg = d3.select("#player-position-chart")
      .append("svg")
      .attr("width", width)
      .attr("height", height);
  
    const chartArea = svg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);
  
    const xScale = d3.scaleBand().padding(0.1).range([0, width - margin.left - margin.right]);
    const yScale = d3.scaleLinear().range([height - margin.top - margin.bottom, 0]);
  
    const xAxisGroup = chartArea.append("g")
      .attr("transform", `translate(0, ${height - margin.top - margin.bottom})`);
  
    const yAxisGroup = chartArea.append("g");
  
    const tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);
  
    function render(data) {
      xScale.domain(data.map(d => d.position));
      yScale.domain([0, d3.max(data, d => d.count)]).nice();
  
      xAxisGroup.call(d3.axisBottom(xScale)).selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");
  
      yAxisGroup.call(d3.axisLeft(yScale));
  
      const bars = chartArea.selectAll(".bar")
        .data(data, d => d.position);
  

      bars.enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", d => xScale(d.position))
        .attr("y", d => yScale(d.count))
        .attr("width", xScale.bandwidth())
        .attr("height", d => height - margin.top - margin.bottom - yScale(d.count))
        .attr("fill", "#69b3a2")
        .on("mouseover", function(event, d) {
          tooltip.transition().duration(200).style("opacity", .9);
          tooltip.html(`Nation: ${d.nation}<br>Position: ${d.position}<br>Count: ${d.count}`)
            .style("left", (event.pageX + 5) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
  

      bars
        .transition()
        .duration(500)
        .attr("x", d => xScale(d.position))
        .attr("y", d => yScale(d.count))
        .attr("width", xScale.bandwidth())
        .attr("height", d => height - margin.top - margin.bottom - yScale(d.count));
  

      bars.exit().remove();
    }
  

    render(getNationData('all'));
  
    document.getElementById('nationSelect').addEventListener('change', function() {
      const selectedNation = this.value;
      const filteredData = getNationData(selectedNation);
      render(filteredData);
    });
  </script>




<!-- <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Data passed from Django (just to show an example)
      const leftFootedPlayers = {{ left_footed_players }};
      const rightFootedPlayers = {{ right_footed_players }};
  
      // Data for the chart: left and right footed players
      const footData = [
        { foot: "Left", count: leftFootedPlayers },
        { foot: "Right", count: rightFootedPlayers }
      ];
  
      // Chart settings
      const margin = { top: 30, right: 30, bottom: 70, left: 120 };
      const width = 600;
      const height = 400;
  
      // Create the SVG container for the chart
      const svg = d3.select("#preferred-foot-chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
  
      const chartArea = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);
  
      // Set up the scales for x and y axes
      const xScale = d3.scaleBand().padding(0.3).range([0, width - margin.left - margin.right]);
      const yScale = d3.scaleLinear().range([height - margin.top - margin.bottom, 0]);
  
      // Create the x and y axis groups
      const xAxisGroup = chartArea.append("g")
        .attr("transform", `translate(0, ${height - margin.top - margin.bottom})`);
  
      const yAxisGroup = chartArea.append("g");
  
      // Set the domains for the axes based on the data
      xScale.domain(footData.map(d => d.foot));
      yScale.domain([0, d3.max(footData, d => d.count)]).nice();
  
      // Add x and y axes to the chart
      xAxisGroup.call(d3.axisBottom(xScale)).selectAll("text").style("text-anchor", "middle");
      yAxisGroup.call(d3.axisLeft(yScale));
  
      // Create bars for the chart
      chartArea.selectAll(".bar-foot")
        .data(footData)
        .enter()
        .append("rect")
        .attr("class", "bar-foot")
        .attr("x", d => xScale(d.foot))
        .attr("y", d => yScale(d.count))
        .attr("width", xScale.bandwidth())
        .attr("height", d => height - margin.top - margin.bottom - yScale(d.count))
        .attr("fill", d => d.foot === "Left" ? "#1f77b4" : "#ff7f0e");
  
      // Add labels to the bars
      chartArea.selectAll(".label")
        .data(footData)
        .enter()
        .append("text")
        .attr("class", "label")
        .attr("x", d => xScale(d.foot) + xScale.bandwidth() / 2)
        .attr("y", d => yScale(d.count) - 5)
        .attr("text-anchor", "middle")
        .text(d => d.count);
    });
  </script> -->

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Global player counts
      const leftFootedPlayers = {{ left_footed_players }};
      const rightFootedPlayers = {{ right_footed_players }};
  
      // Data for each position
      const posData = [
        {% for data in pos_attribute_data %}
          {
            position: "{{ data.position }}",
            left: {{ data.count_left }},
            right: {{ data.count_right }}
          },
        {% endfor %}
      ];
  
      // Tooltip setup
      const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
  
      // Chart setup
      const margin = { top: 30, right: 30, bottom: 70, left: 120 };
      const width = 600;
      const height = 400;
  
      const svg = d3.select("#preferred-foot-chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
  
      const chartArea = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);
  
      const xScale = d3.scaleBand().padding(0.3).range([0, width - margin.left - margin.right]);
      const yScale = d3.scaleLinear().range([height - margin.top - margin.bottom, 0]);
  
      const xAxisGroup = chartArea.append("g")
        .attr("transform", `translate(0, ${height - margin.top - margin.bottom})`);
  
      const yAxisGroup = chartArea.append("g");
  
      function updateChart(left, right) {
        const total = left + right;
        const footData = [
          { foot: "Left", count: left, percentage: ((left / total) * 100).toFixed(1) },
          { foot: "Right", count: right, percentage: ((right / total) * 100).toFixed(1) }
        ];
  
        xScale.domain(footData.map(d => d.foot));
        yScale.domain([0, d3.max(footData, d => d.count)]).nice();
  
        xAxisGroup.call(d3.axisBottom(xScale));
        yAxisGroup.call(d3.axisLeft(yScale));
  
        const bars = chartArea.selectAll(".bar-foot")
          .data(footData);
  
        bars.enter()
          .append("rect")
          .attr("class", "bar-foot")
          .merge(bars)
          .on("mouseover", function (event, d) {
            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(`Foot: ${d.foot}<br>Count: ${d.count}<br>Percentage: ${d.percentage}%`)
              .style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0))
          .transition()
          .duration(500)
          .attr("x", d => xScale(d.foot))
          .attr("y", d => yScale(d.count))
          .attr("width", xScale.bandwidth())
          .attr("height", d => height - margin.top - margin.bottom - yScale(d.count))
          .attr("fill", d => d.foot === "Left" ? "#1f77b4" : "#ff7f0e");
  
        bars.exit().remove();
  
        const labels = chartArea.selectAll(".label")
          .data(footData);
  
        labels.enter()
          .append("text")
          .attr("class", "label")
          .style("fill", "white")
          .merge(labels)
          .transition()
          .duration(500)
          .attr("x", d => xScale(d.foot) + xScale.bandwidth() / 2)
          .attr("y", d => yScale(d.count) - 5)
          .attr("text-anchor", "middle")
          .text(d => d.count);
  
        labels.exit().remove();
      }
  
      // Initial chart render
      updateChart(leftFootedPlayers, rightFootedPlayers);
  
      // Dropdown filter
      const dropdown = document.getElementById("positionSelect-foot");
      dropdown.addEventListener("change", function () {
        const selectedPosition = this.value;
  
        if (selectedPosition === "all") {
          updateChart(leftFootedPlayers, rightFootedPlayers);
        } else {
          const found = posData.find(p => p.position === selectedPosition);
          if (found) {
            updateChart(found.left, found.right);
          }
        }
      });
    });
  </script>





  


</body>
</html>